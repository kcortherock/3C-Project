<!DOCTYPE html>
<html lang="en">

<style>
  table {
    width: 60%;
    border-collapse: collapse;
    border: 1px solid;
    margin: 20px 0;
  }
  th, td {
    border: 1px solid;
  }
  h1{
    text-align: center;
  }
  .table1{
    text-align: center;
  }
  #notification {
    display: none;
    color: white;
    padding: 10px;
    background-color: red;
    text-align: center;
  }
</style>

<body>
  <div id="notification"></div>
  <h1>Overall Complexity Score & Color Customization</h1>
  <li>You can select a color for a specific overall score according to your preferences.</li>

  <table>
    <thead>
      <tr>
        <th>Score that is bigger than</th>
        <th>Color</th>
      </tr>
      <tr>
        <td class="table1"><input type="number" name="score1" class="allScoreTable1" placeholder="Enter score" value="8" min="0"></td>
        <td class="table1">
          <select name="color1">
            <option value="Red" selected>Red</option>
            <option value="Green">Green</option>
            <option value="Blue">Blue</option>
            <option value="Yellow">Yellow</option>
            <option value="Orange">Orange</option>
            <option value="Purple">Purple</option>
            <option value="Cyan">Cyan</option>
          </select>
        </td>
      </tr>
      <tr>
        <td class="table1"><input type="number" name="score2" class="allScoreTable1" placeholder="Enter score" value="5" min="0"></td>
        <td class="table1">
          <select name="color2">
            <option value="Red">Red</option>
            <option value="Green" selected>Green</option>
            <option value="Blue">Blue</option>
            <option value="Yellow">Yellow</option>
            <option value="Orange">Orange</option>
            <option value="Purple">Purple</option>
            <option value="Cyan">Cyan</option>
          </select>
        </td>
      </tr>
      <tr>
        <td class="table1"><input type="number" name="score3" class="allScoreTable1" placeholder="Enter score" value="3" min="0"></td>
        <td class="table1">
          <select name="color3">
            <option value="Red">Red</option>
            <option value="Green">Green</option>
            <option value="Blue" selected>Blue</option>
            <option value="Yellow">Yellow</option>
            <option value="Orange">Orange</option>
            <option value="Purple">Purple</option>
            <option value="Cyan">Cyan</option>
          </select>
        </td>
      </tr>
      <tr>
        <td class="table1"><input type="number" name="score4" class="allScoreTable1" placeholder="Enter score" value="1" min="0"></td>
        <td class="table1">
          <select name="color4">
            <option value="Red">Red</option>
            <option value="Green">Green</option>
            <option value="Blue">Blue</option>
            <option value="Yellow" selected>Yellow</option>
            <option value="Orange">Orange</option>
            <option value="Purple">Purple</option>
            <option value="Cyan">Cyan</option>
          </select>
        </td>
      </tr>
      
    </thead>
  </table>
  
  <h1>Score Value Customization</h1>
  <li>You can select specific scores for below options according to your preferences.</li>
  <li>Note: Scores must be between 0 and 10.</li>
  <table>
    <thead>
      <tr>
        <th>Options</th>
        <th>Score</th>
      </tr>
      <tr>
        <td>If Score</td>
        <td class="table1"><input type="number" name="ifScore" class="allScoreTable2" min="0" max="10" value="1"></td>
      </tr>
      <tr>
        <td>Else Score</td>
        <td class="table1"><input type="number" name="elseScore" class="allScoreTable2" min="0" max="10" value="1"></td>
      </tr>
      <tr>
        <td>While Score</td>
        <td class="table1"><input type="number" name="whileScore" class="allScoreTable2" min="0" max="10" value="1"></td>
      </tr>
      <tr>
        <td>Do-While Score</td>
        <td class="table1"><input type="number" name="dowhileScore" class="allScoreTable2" min="0" max="10" value="1"></td>
      </tr>
      <tr>
        <td>For Score</td>
        <td class="table1"><input type="number" name="forScore" class="allScoreTable2" min="0" max="10" value="1"></td>
      </tr>
       <tr>
        <td>Binary Op Score</td>
        <td class="table1"><input type="number" name="binaryopScore" class="allScoreTable2" min="0" max="10" value="1"></td>
      </tr>
      <tr>
        <td>Switch Score</td>
        <td class="table1"><input type="number" name="switchScore" class="allScoreTable2" min="0" max="10" value="1"></td>
      </tr>
      <tr>
        <td>Case Score</td>
        <td class="table1"><input type="number" name="caseScore" class="allScoreTable2" min="0" max="10" value="1"></td>
      </tr>
      <tr>
        <td>AND Score</td>
        <td class="table1"><input type="number" name="andScore" class="allScoreTable2" min="0" max="10" value="1"></td>
      </tr>
      <tr>
        <td>OR Score</td>
        <td class="table1"><input type="number" name="orScore" class="allScoreTable2" min="0" max="10" value="1"></td>
      </tr>
      <tr>
        <td>Op Change Score</td>
        <td class="table1"><input type="number" name="opchangeScore" class="allScoreTable2" min="0" max="10" value="1"></td>
      </tr>
      <tr>
        <td>Loop Nesting Score</td>
        <td class="table1"><input type="number" name="loopNesting" class="allScoreTable2" min="0" max="10" value="1"></td>
      </tr>
      <tr>
        <td>Condition Nesting Score</td>
        <td class="table1"><input type="number" name="condNesting" class="allScoreTable2" min="0" max="10" value="1"></td>
      </tr>
      <tr>
        <td>For with following another For Score</td>
        <td class="table1"><input type="number" name="forFollowingFor" class="allScoreTable2" min="0" max="10" value="1"></td>
      </tr>
      <tr>
        <td>For with following If Score</td>
        <td class="table1"><input type="number" name="forFollowingIf" class="allScoreTable2" min="0" max="10" value="1"></td>
      </tr>
      <tr>
        <td>If with following another If Score</td>
        <td class="table1"><input type="number" name="ifFollowingIf" class="allScoreTable2" min="0" max="10" value="1"></td>
      </tr>
      <tr>
        <td>If with following For Score</td>
        <td class="table1"><input type="number" name="ifFollowingFor" class="allScoreTable2" min="0" max="10" value="1"></td>
      </tr>
      
    </thead>
  </table>
  
  <button id="saveButton">Save</button>
  <button id="resetButton">Reset</button>
  
</body>

<script>
    // Fix: Properly define vscode API for webview context
    const vscode = acquireVsCodeApi();

    function setDefaults() {
        const overallScoreInputs = document.querySelectorAll(".allScoreTable1");
        const scoreValueInputs = document.querySelectorAll(".allScoreTable2");

        const defaultScores = ["8", "5", "3", "1"];
        const defaultOptions = [
          1, 1, 4, 4, 4,
          1, 1, 1, 1, 2,
          1, 1, 1, 2, 1,
          1, 2
        ];

        for (let i = 0; i < overallScoreInputs.length; i++) {
          overallScoreInputs[i].value = defaultScores[i];
        }

        for (let i = 0; i < scoreValueInputs.length; i++) {
          scoreValueInputs[i].value = defaultOptions[i];
        }

        document.querySelector("select[name='color1']").value = "Red";
        document.querySelector("select[name='color2']").value = "Green";
        document.querySelector("select[name='color3']").value = "Blue";
        document.querySelector("select[name='color4']").value = "Yellow";
    }

    // Call when page loads
    window.onload = function () {
        console.log('Page loaded, requesting scores and colors...');
        vscode.postMessage({ command: 'getScores' }); // Sending getScores to Webview
        vscode.postMessage({ command: 'getColours' }); // Sending getColours to Webview
    };

    window.addEventListener('message', event => {
        const data = event.data;
        console.log('Received message:', data);
        
        if (data.command === 'sendScores') {  // Get scores message from Webview
            console.log('Processing scores:', data.scores);
            for (const key in data.scores) {
                const inputs = document.getElementsByName(key);
                console.log(`Looking for input with name: ${key}, found: ${inputs.length} elements`);
                if (inputs.length > 0) {
                    inputs[0].value = data.scores[key];
                    console.log(`Set ${key} to ${data.scores[key]}`);
                } else {
                    console.warn(`No input found for key: ${key}`);
                }
            }
        }
        else if (data.command === 'sendColours') {  // Get colours message from Webview
            console.log('Processing colors:', data.colours);
            for (const key in data.colours) {
                const inputs = document.getElementsByName(key);
                console.log(`Looking for input with name: ${key}, found: ${inputs.length} elements`);
                if (inputs.length > 0) {
                    inputs[0].value = data.colours[key];
                    console.log(`Set ${key} to ${data.colours[key]}`);
                } else {
                    console.warn(`No input found for key: ${key}`);
                }
            }
        }
    });
    
    document.getElementById("saveButton").addEventListener("click", function() {
      const overallScoreComplexity = document.querySelectorAll(".allScoreTable1");
      const scoreValueCustomization = document.querySelectorAll(".allScoreTable2");
      const colorSelects = document.querySelectorAll("select[name^='color']");
      
      const overallScoreComplexityList = [];
      const scoreValueCustomizationList = [];
      const colorsList = [];
      
      // Collect scores and colors
      for (let i=0; i<overallScoreComplexity.length; i++){
        overallScoreComplexityList.push(overallScoreComplexity[i].value);
      }
      
      for (let i=0; i<scoreValueCustomization.length; i++){
        scoreValueCustomizationList.push(scoreValueCustomization[i].value);
      }
      
      for (let i=0; i<colorSelects.length; i++) {
        colorsList.push(colorSelects[i].value);
      }
      
      // Validation flags
      const uniqueScores = new Set(overallScoreComplexityList);
      let emptyScoreFlag = false;
      let uniqueScoreFlag = false;
      let invalidValueFlag = false;
      let negativeValueFlag = false;
      
      // Validation checks
      for (let i=0; i<overallScoreComplexityList.length; i++){
        if (overallScoreComplexityList[i] == ''){
          emptyScoreFlag = true;
          break;
        }
        if (parseInt(overallScoreComplexityList[i]) < 0){
          negativeValueFlag = true;
          break;
        }
      }
      
      for (let i=0; i<scoreValueCustomizationList.length; i++){
        if (parseInt(scoreValueCustomizationList[i]) > 10) {
          invalidValueFlag = true;
          break;
        }
        if (parseInt(scoreValueCustomizationList[i]) < 0){
          negativeValueFlag = true;
          break;
        }
      }
      
      if(uniqueScores.size != overallScoreComplexityList.length){
        uniqueScoreFlag = true;
      }
      
      // Handle notifications
      const notification = document.getElementById("notification");
      
      if (invalidValueFlag) {
        notification.innerHTML = "The options scores cannot be bigger than 10. Please check again.";
      }
      else if (negativeValueFlag) {
        notification.innerHTML = "The scores cannot be negative. Please check again.";
      }
      else if (uniqueScoreFlag && emptyScoreFlag){
        notification.innerHTML = "The overall score values must be unique and cannot be empty. Please check the values again.";
      }
      else if (uniqueScoreFlag){
        notification.innerHTML = "The overall score values must be unique. Please check the values again.";
      }
      else if (emptyScoreFlag){
        notification.innerHTML = "The overall score values cannot be empty. Please check the values again.";
      }
      else {
        // Success path - send to extension
        const message = {
          command: 'saveScores',
          overallScores: overallScoreComplexityList,
          optionScores: scoreValueCustomizationList,
          colors: colorsList
        };
        
        console.log("Sending to VS Code extension:", message);
        vscode.postMessage(message);
        notification.innerHTML = "Settings saved successfully!";
        notification.style.backgroundColor = "green";
        notification.style.display = "block";
        
        setTimeout(function() {
          notification.style.display = "none";
        }, 3000);
        
        return;
      }
      
      // Display error notification
      notification.style.display = "block";
      setTimeout(function() {
        notification.style.display = "none";
      }, 5000);
    });
    
    // Add reset button functionality
    document.getElementById("resetButton").addEventListener("click", function() {
      setDefaults();
      
      // Show notification
      const notification = document.getElementById("notification");
      notification.innerHTML = "Settings reset to defaults";
      notification.style.backgroundColor = "blue";
      notification.style.display = "block";
      
      setTimeout(function() {
        notification.style.display = "none";
      }, 3000);
    });
</script>
</html>